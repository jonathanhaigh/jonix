head	1.1;
access;
symbols;
locks
	jonathan:1.1; strict;
comment	@ * @;


1.1
date	2007.12.12.21.48.11;	author jonathan;	state Exp;
branches;
next	;


desc
@Kernel Utils: String functions.
@


1.1
log
@Initial revision
@
text
@/* --------------------------------------------------
*   Filename:       $RCSfile$
*
*   Revision:       $Revision$
*
*   Author(s):      
*
*   Last Updated:   $Date$
*
*   Updated By:     $Author$
*
* ---------------------------------------------------
*
*   $Log$
*
* -------------------------------------------------*/

#include "stdint.h"
#include "system.h"

char digit_str[]    = "0123456789abcdef";

/*
 * This macro is to make functions called something like char2str_10, and int2str_16
 * that convert a char or int into a string representation base 10, and base 16 respectively.
 * 
 * A macro is used rather than a function because the length of the digits array depends
 * on the base.
 *
 * The parameter max_strlen_pc is the max number of characters required to represent a
 * char in this base. It does depend entirely on the base, but the C preprocessor can't
 * do the maths.
 */
#define define_num2str(base, num_type, max_strlen_pc)                       \
void num_type ## 2str_ ## base (char *dest, num_type num){                  \
                                                                            \
    int i;                                                                  \
    bool print_flag;                                                        \
    int digits[max_strlen_pc * sizeof(num_type)];                           \
                                                                            \
   /* if(num < 0){                                                          \
        *dest   = '-';                                                      \
        dest++;                                                             \
        num = -num;                                                         \
    } */                                                                    \
                                                                            \
    for( i=0 ; i < sizeof(num_type) * max_strlen_pc ; i++){                 \
        digits[i]   = num % base;                                           \
        num         /= base;                                                \
    }                                                                       \
    for( i--, print_flag=0 ; i>=0 ; i-- ){                                  \
        if(digits[i]){                                                      \
            print_flag  = 1;                                                \
        }                                                                   \
        if(print_flag){                                                     \
            *dest   = digit_str[digits[i]];                                 \
            dest++;                                                         \
        }                                                                   \
    }                                                                       \
                                                                            \
    if(!print_flag){                                                        \
        *dest   = '0';                                                      \
        dest++;                                                             \
    }                                                                       \
                                                                            \
    *dest   = 0;                                                            \
}



define_num2str(10, char, 3)
define_num2str(10, int,  3)
define_num2str(16, char, 2)
define_num2str(16, int,  2)

void long2str_10h(char *dest, unsigned long num, unsigned char precision){
    /*
     * TODO: Add a max length argument
     */

    char need_plus  = 0;

    if(precision && num >= 1073741824){ 
        /* 1GB */

        int2str_10(dest, num/1073741824);
        num         %= 1073741824;

        while(*dest != 0){
            dest++;
        }
        *(dest++)   = 'G';

        precision--;
        need_plus   = 1;
    }

    if(precision && num >= 1048576){ 

        if(need_plus){
            *(dest++)   = '+';
        }

        int2str_10(dest, num/1048576);
        num         %= 1048576;

        while(*dest != 0){
            dest++;
        }
        *(dest++)   = 'M';

        precision--;
        need_plus   = 1;
    }
    
    if(precision && num >= 1024){
        /* 1kB */
        if(need_plus){
            *(dest++)   = '+';
        }

        int2str_10(dest, num/1024);
        num         %= 1024;

        while(*dest != 0){
            dest++;
        }
        *dest       = 'k';
        *(++dest)   = 0;

        precision--;
        need_plus   = 1;
    }

    if(precision && num >= 0){
        /* 1kB */
        if(need_plus){
            *(dest++)   = '+';
        }

        int2str_10(dest, num);
        need_plus   = 1;
    }

}

char uc(const char c){
    return c + 0x20;
}
@
